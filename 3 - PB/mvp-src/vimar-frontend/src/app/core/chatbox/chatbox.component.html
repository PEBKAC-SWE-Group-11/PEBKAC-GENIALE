<div class="chatbox">
   <div class="chat-view">
       <div class="chat-header">
           <button class="sidebar-toggle" (click)="onToggleSidebar()" aria-label="Toggle sidebar">
             <i class="bi bi-list"></i>
           </button>
           <h2> Conversazione {{ activeConversation?.conversationId }}</h2>
       </div>
        <div class="messages-area">
            <div *ngFor="let message of messages$ | async" 
                class="message"
                [ngClass]="{
                'user-message': message.sender === 'user',
                'assistant-message': message.sender === 'assistant',
                'message-with-feedback': message.feedback
                }">
                <div class="message-content">
                    {{ message.content }}
                </div>
                
                <!-- Pulsanti di feedback solo per i messaggi dell'assistente -->
                <div class="feedback-buttons" *ngIf="message.sender === 'assistant' && !message.feedback">
                    <button 
                      class="feedback-btn positive" 
                      (click)="sendPositiveFeedback(message.messageId)"
                      title="Feedback positivo">
                      <i class="bi bi-hand-thumbs-up"></i>
                    </button>
                    <button 
                      class="feedback-btn negative" 
                      (click)="sendNegativeFeedback(message.messageId)"
                      title="Feedback negativo">
                      <i class="bi bi-hand-thumbs-down"></i>
                    </button>
                </div>
                
                <!-- Visualizzazione del feedback giÃ  dato -->
                <div class="feedback-display" *ngIf="message.feedback">
                    <span class="feedback-icon" 
                          [ngClass]="{'positive': message.feedback.type === 'positive', 
                                      'negative': message.feedback.type === 'negative'}">
                        <i class="bi" 
                           [ngClass]="{'bi-hand-thumbs-up': message.feedback.type === 'positive', 
                                       'bi-hand-thumbs-down': message.feedback.type === 'negative'}"></i>
                    </span>
                    <span class="feedback-text" *ngIf="message.feedback.content">
                        {{ message.feedback.content }}
                    </span>
                </div>
            </div>
            
            <!-- Indicatore di caricamento mentre si attende la risposta -->
            <div class="loading-indicator" *ngIf="isLoading">
                <div class="spinner"></div>
                <span>Sto pensando...</span>
            </div>
        </div>
        
        <div class="message-input">
            <textarea 
                [(ngModel)]="newMessage" 
                placeholder="Scrivi un messaggio..." 
                (input)="checkMessageLength()"
                (keydown)="onKeyPress($event)"
                [disabled]="isLoading"></textarea>
            <button 
                class="send-btn" 
                [disabled]="isLoading || !newMessage.trim()" 
                (click)="sendMessage()">
                <span *ngIf="!isLoading">Invia</span>
                <span *ngIf="isLoading">
                    <i class="bi bi-hourglass-split"></i>
                </span>
            </button>
        </div>
    </div>
    
    <!-- Popup di Feedback -->
    <div class="feedback-popup" *ngIf="showFeedbackPopup">
        <div class="feedback-popup-content">
            <h3>
                <i class="bi" 
                   [ngClass]="{'bi-hand-thumbs-up': feedbackIsPositive, 
                               'bi-hand-thumbs-down': !feedbackIsPositive}"></i>
                {{ feedbackIsPositive ? 'Feedback Positivo' : 'Feedback Negativo' }}
            </h3>
            <textarea 
                [(ngModel)]="feedbackContent" 
                placeholder="Aggiungi un commento (opzionale)"
                maxlength="300"></textarea>
            <div class="char-counter">
                {{ remainingFeedbackChars }} caratteri rimanenti
            </div>
            <div class="feedback-buttons">
                <button class="cancel-btn" (click)="closeFeedbackPopup()">Annulla</button>
                <button class="submit-btn" (click)="submitFeedback()">Invia Feedback</button>
            </div>
        </div>
    </div>
</div>